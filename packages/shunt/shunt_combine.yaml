# Updated : 2025.12.22
# Version : 1.5.9
# GitHub  : https://github.com/Sleeper85/esphome-yambms

# This YAML is free software: you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation, either version 3
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/gpl.html>.

substitutions:
  bms_ids: '{0}'

globals:
  - id: shunt${shunt_id}_combined
    type: bool
    restore_value: no
    initial_value: "false"
  - id: shunt${shunt_id}_bms_map
    type: std::vector<uint8_t>
    initial_value: '${bms_ids}'
  - id: shunt${shunt_id}_bms_caused_uncombine
    type: bool
    restore_value: no
    initial_value: "false"

# Combine once without conditions
esphome:
  on_boot:
    then:
      # Shunt counter (total)
      - lambda: id(${yambms_id}_var_shunt_counter) += 1;

switch:
  # Combine enable/disable Switch
  - platform: template
    name: "Combine enabled"
    id: shunt${shunt_id}_switch_combine
    device_id: shunt_${shunt_id}
    restore_mode: RESTORE_DEFAULT_ON
    optimistic: true

binary_sensor:
  # Indicates whether the Shunt can be combined
  - platform: template
    name: "Can be combined"
    id: shunt${shunt_id}_can_be_combined
    device_id: shunt_${shunt_id}
    lambda: return (id(shunt${shunt_id}_switch_combine).state && id(shunt${shunt_id}_online_status).state);

interval:
  - interval: ${yambms_update_interval}
    then:
      - lambda: |-
          // Shunt number to combine ?
          if (id(${yambms_id}_var_to_combine_shunt_number) == ${shunt_id})
          {
            // The Shunt can be combined ?
            if (id(shunt${shunt_id}_can_be_combined).state)
            {
              // +-----------------------------------------------+
              // | Check if all connected BMS are online         |
              // +-----------------------------------------------+
              bool all_bms_online = true;
              for (auto const& bms_id : id(shunt${shunt_id}_bms_map))
              {
                if (!bms_id) continue;
                if ((id(${yambms_id}_var_bms_online_bitmask) & (1 << (bms_id - 1))) == 0)
                {
                  all_bms_online = false;
                  break;
                }
              }

              if (!all_bms_online) {
                ESP_LOGI("shunt_combine", "Shunt %d: Not all connected BMS are online, uncombining.", ${shunt_id});
                id(shunt${shunt_id}_switch_combine).turn_off();
                id(shunt${shunt_id}_bms_caused_uncombine) = true;
              }

              // +-----------------------------------------------+
              // | Combine not continuously                      |
              // +-----------------------------------------------+

              if (id(shunt${shunt_id}_combined) == false)
              {
                // To combine shunt counter
                id(${yambms_id}_var_to_combine_shunt_counter) += 1;

                // Shunt use (replace BMS infos)
                id(${yambms_id}_var_shunt_use) = true;

                // Combined
                id(shunt${shunt_id}_combined) = true;
              }

              // +-----------------------------------------------+
              // | Combine continuously                          |
              // +-----------------------------------------------+

              // TOTAL voltage
              id(${yambms_id}_var_shunt_total_voltage) += id(shunt${shunt_id}_voltage).state;
              // TOTAL current
              id(${yambms_id}_var_shunt_total_current) += id(shunt${shunt_id}_current).state;
              // TOTAL power
              id(${yambms_id}_var_shunt_total_power) += id(shunt${shunt_id}_power).state;
              // TOTAL soc
              id(${yambms_id}_var_shunt_total_soc) += id(shunt${shunt_id}_soc).state;

            }

            // +-----------------------------------------------+
            // | Uncombine not continuously                    |
            // +-----------------------------------------------+
            else if (id(shunt${shunt_id}_combined) == true)
            {
              // To combine shunt counter
              id(${yambms_id}_var_to_combine_shunt_counter) -= 1;

              // Shunt use (replace BMS infos)
              if (id(${yambms_id}_var_to_combine_shunt_counter) == 0) id(${yambms_id}_var_shunt_use) = false;

              // Uncombined
              id(shunt${shunt_id}_combined) = false;
            } else if (id(shunt${shunt_id}_bms_caused_uncombine)) {
              // +-----------------------------------------------+
              // | Check if all connected BMS are online again   |
              // +-----------------------------------------------+
              bool all_bms_online = true;
              for (auto const& bms_id : id(shunt${shunt_id}_bms_map))
              {
                if (!bms_id) continue;
                if ((id(${yambms_id}_var_bms_online_bitmask) & (1 << (bms_id - 1))) == 0)
                {
                  all_bms_online = false;
                  break;
                }
              }

              if (all_bms_online) {
                ESP_LOGI("shunt_combine", "Shunt %d: All connected BMS are online again, combining.", ${shunt_id});
                id(shunt${shunt_id}_switch_combine).turn_on();
                id(shunt${shunt_id}_bms_caused_uncombine) = false;
              }
            }

            // Increment the counter for next Shunt processing
            id(${yambms_id}_var_to_combine_shunt_number)++;
          }