# Updated : 2025.06.29
# Version : 1.5.8
# GitHub  : https://github.com/Sleeper85/esphome-yambms

# YamBMS ( Yet another multi-BMS Merging Solution )

# This YAML is free software: you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation, either version 3
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/gpl.html>.

######################## YamBMS Local Packages Version #########################

# You need to copy the `packages` folder into the same folder as this YAML in order to compile it.
# Don't forget to configure your WiFi credentials in the secrets.yaml

################################################################################

# Don't forget to configure your WiFi credentials in the secrets.yaml
#
# If needed, configure a static IP here
# wifi:
#   manual_ip:
#     static_ip: 192.168.0.85
#     gateway: 192.168.0.1
#     subnet: 255.255.255.0
#     dns1: 8.8.8.8
#     dns2: 8.8.4.4

external_components:
  - source: github://pr#12421
    components: [uart, modbus, modbus_controller, modbus_server]
    refresh: 1h

logger:
  level: DEBUG # VERBOSE / DEBUG / INFO / WARN
  logs:
    canbus: WARN

ota:
  platform: esphome
  
# Please use the native `api` component instead of the `mqtt` section.
# If you use Home Assistant, the native API is more lightweight.
# If there is no HA server connected to this API, the ESP32 reboots every 15 minutes to try to resolve the problem.
# The "reboot_timeout: 0s" option will keep your ESP32 up and running even if you lose connection to your HA server.
api:
  reboot_timeout: 0s

# If you don't want to use ESPHome's native API you can use MQTT instead.
# In this case don't forget to remove the 'api:' section.
# mqtt:
#   broker: !secret mqtt_host
#   username: !secret mqtt_username
#   password: !secret mqtt_password
#   id: mqtt_client

# Please note that enabling this component will take up a lot of memory and may decrease
# stability and be the cause of reboot depending on the capabilities of the board used.
# web_server:
#   port: 80
#   log: false
#   ota: false

# +--------------------------------------+
# | Global Settings                      |
# +--------------------------------------+
substitutions:
  # ESP32 name / hostname
  # Name
  name: '' # Name that can be added as a second prefix after the friendly name, you can leave it blank.
  hostname: 'yambms4' # This is the name of the node. It should always be unique in your ESPHome network.
  friendly_name : 'YamBMS4' # Prefix added in front of all entity names and also to classify them.
  # +--------------------------------------+
  # | YamBMS Settings                      |
  # +--------------------------------------+
  # Please read the cut-off charging logic README to understand how the YamBMS works
  yambms_id: 'yambms4'
  yambms_name: 'YamBMS 4'
  #yambms_update_interval: '1s'

  # +--------------------------------------+
  # | BMS Settings                         |
  # +--------------------------------------+
  bms_update_interval: '5s'    # frequency at which BMS data is refreshed, going below '3s' can cause problems
  
  # Modbus options
  modbus_update_interval: '5s' # frequency with which BMS/Shunt modbus servers are queried
  modbus_baud_rate: '38400' # 9600 / 19200 / 11520
  modbus_command_throttle: '0ms' # minimum time in between 2 requests to the device
  modbus_send_wait_time: '250ms' # time in milliseconds before the next ModBUS command is sent if an answer from a previous command is pending

# +--------------------------------------+
# | Packages                             |
# +--------------------------------------+

# PLEASE READ : https://github.com/Sleeper85/esphome-yambms/blob/main/documents/README/YamBMS_main_YAML_HowTo.md

packages:
  # Board options
  device_board: !include packages/board/board_ESP32_LilyGo-T-CAN485.yaml

  # RS485
  uart_esp_1: !include packages/board/board_options_itf_uart_esp_1.yaml

  ############################################################

  modbus: !include
    file: packages/board/board_options_itf_modbus.yaml
    vars:
      modbus_role: 'server' # client / server
      modbus_uart_id: 'uart_esp_1' # RS485 port

  # Balancer for BMS 3: Basen 1
  balancer3: !include
    file: packages/balancer/balancer_modbus_JK_NEEY_BLE.yaml
    vars:
      bms_id: '3' # must be a number
      balancer_name: 'NEEY 1'
      balancer_ble_mac_address: !secret neey1_mac

  # Balancer for BMS 4: Basen 2
  balancer4: !include
    file: packages/balancer/balancer_modbus_JK_NEEY_BLE.yaml
    vars:
      bms_id: '4' # must be a number
      balancer_name: 'NEEY 2'
      balancer_ble_mac_address: !secret neey2_mac

# +--------------------------------------+
# | DEBUG ( logger level must be DEBUG ) |
# +--------------------------------------+

  device_debug: !include
    file: packages/base/device_debug_ESP32.yaml
    vars:
      debug_name: 'Debug'
      debug_update_interval: '5s'
