views:
  - type: sections
    path: pv
    title: PV
    layout:
      grid-template-columns: 33% 33% 33%
      grid-template-rows: auto auto auto
      grid-template-areas: |
        "g1 g2 g3"
        "o1 o1 o1"
      justify-items: stretch
    cards: []
    sections:
      - type: grid
        cards:
          - type: custom:flex-horseshoe-card
            entities:
              - entity: sensor.sun12k_battery_capacity
                decimals: 0
                unit: '%'
                name: BATTERY
              - entity: sensor.sun12k_battery_voltage
                decimals: 2
                unit: V
              - entity: sensor.sun12k_battery_output_current
                decimals: 2
                unit: A
              - entity: sensor.sun12k_battery_output_power
                decimals: 0
                unit: W
              - entity: sensor.sun12k_daily_battery_discharge
                decimals: 1
                unit: kWh
                name: Discharge
              - entity: sensor.sun12k_daily_battery_charge
                decimals: 1
                unit: kWh
                name: Charge
              - entity: sensor.sun12k_battery_temperature
                decimals: 0
                unit: °C
                name: Temperature
            show:
              horseshoe_style: colorstop
            layout:
              hlines:
                - id: 0
                  xpos: 50
                  ypos: 40
                  length: 70
                  styles:
                    - opacity: 0.2;
                - id: 0
                  xpos: 50
                  ypos: 60
                  length: 70
                  styles:
                    - opacity: 0.2;
              vlines:
                - id: 0
                  xpos: 50
                  ypos: 50
                  length: 18
                  styles:
                    - opacity: 0.2;
              states:
                - id: 0
                  entity_index: 0
                  xpos: 50
                  ypos: 33
                  styles:
                    - font-size: 3em;
                    - opacity: 0.9;
                - id: 1
                  entity_index: 1
                  xpos: 44
                  ypos: 53
                  styles:
                    - font-size: 1.5em;
                    - text-anchor: end;
                - id: 2
                  entity_index: 2
                  xpos: 55
                  ypos: 53
                  styles:
                    - text-anchor: start;
                    - font-size: 1.5em;
                - id: 3
                  entity_index: 3
                  xpos: 50
                  ypos: 75
                  styles:
                    - text-anchor: middle;
                    - font-size: 2em;
                - id: 4
                  entity_index: 4
                  xpos: 76
                  ypos: 7
                  styles:
                    - text-anchor: start;
                    - font-size: 1.1em;
                - id: 5
                  entity_index: 5
                  xpos: 0
                  ypos: 7
                  styles:
                    - text-anchor: start;
                    - font-size: 1.1em;
                - id: 6
                  entity_index: 6
                  xpos: 0
                  ypos: 95
                  styles:
                    - text-anchor: start;
                    - font-size: 1.2em;
              icons:
                - id: 0
                  entity_index: 1
                  xpos: 30
                  ypos: 52
                  align: start
                  size: 1
              names:
                - id: 0
                  entity_index: 0
                  xpos: 50
                  ypos: 95
                  styles:
                    - font-size: 1.2em;
                - id: 1
                  entity_index: 4
                  xpos: 81
                  ypos: 12
                  styles:
                    - font-size: 0.5em;
                    - text-anchor: start;
                - id: 2
                  entity_index: 5
                  xpos: 0
                  ypos: 12
                  styles:
                    - font-size: 0.5em;
                    - text-anchor: start;
            horseshoe_scale:
              min: 0
              max: 100
              width: 6
            color_stops:
              '0': red
              '10': red
              '20': red
              '30': red
              '40': red
              '55': yellow
              '60': green
              '70': green
              '90': green
            card_mod:
              style: |
                ha-card {
                  --ha-card-background: var(--card-background-color);
                  color: var(--primary-color);
                }
          - type: custom:flex-horseshoe-card
            view_layout:
              grid-area: g1
            entities:
              - entity: sensor.sun12k_load_totalpower
                unit: W
                name: AC
              - entity: sensor.sun12k_grid_voltage_l1
                decimals: 0
                unit: V
              - entity: sensor.sun12k_load_frequency
                decimals: 2
                unit: Hz
                name: Grid
              - entity: sensor.sun12k_total_grid_power
                decimals: 0
                unit: W
                name: Grid
              - entity: sensor.sun12k_daily_energy_bought
                decimals: 1
                unit: kWh
                name: Import
              - entity: sensor.sun12k_daily_energy_sold
                decimals: 1
                unit: kWh
                name: Daily
            show:
              horseshoe_style: autominmax
            layout:
              hlines:
                - id: 0
                  xpos: 50
                  ypos: 40
                  length: 70
                  styles:
                    - opacity: 0.2;
                - id: 0
                  xpos: 50
                  ypos: 60
                  length: 70
                  styles:
                    - opacity: 0.2;
              vlines:
                - id: 0
                  xpos: 50
                  ypos: 50
                  length: 18
                  styles:
                    - opacity: 0.2;
              states:
                - id: 0
                  entity_index: 0
                  xpos: 50
                  ypos: 33
                  styles:
                    - font-size: 3em;
                    - opacity: 0.9;
                    - text-anchor: middle;
                - id: 1
                  entity_index: 1
                  xpos: 44
                  ypos: 53
                  styles:
                    - font-size: 1.5em;
                    - text-anchor: end;
                - id: 2
                  entity_index: 2
                  xpos: 55
                  ypos: 53
                  styles:
                    - text-anchor: start;
                    - font-size: 1.5em;
                - id: 3
                  entity_index: 3
                  xpos: 50
                  ypos: 75
                  styles:
                    - text-anchor: middle;
                    - font-size: 2em;
                - id: 4
                  entity_index: 4
                  xpos: 75
                  ypos: 7
                  styles:
                    - text-anchor: start;
                    - font-size: 1.1em;
                - id: 5
                  entity_index: 5
                  xpos: 0
                  ypos: 7
                  styles:
                    - text-anchor: start;
                    - font-size: 1.1em;
              icons:
                - id: 0
                  entity_index: 1
                  xpos: 30
                  ypos: 52
                  align: start
                  size: 1
              names:
                - id: 0
                  entity_index: 0
                  xpos: 50
                  ypos: 95
                  styles:
                    - font-size: 1.2em;
                - id: 1
                  entity_index: 4
                  xpos: 85
                  ypos: 12
                  styles:
                    - font-size: 0.5em;
                    - text-anchor: start;
                - id: 2
                  entity_index: 5
                  xpos: 0
                  ypos: 12
                  styles:
                    - font-size: 0.5em;
                    - text-anchor: start;
                - id: 3
                  entity_index: 3
                  xpos: 50
                  ypos: 80
                  styles:
                    - font-size: 0.5em;
                    - text-anchor: middle;
            horseshoe_scale:
              min: 0
              max: 8000
              width: 6
            color_stops:
              '0': '#5fb6ad'
              '8000': '#5fb6ad'
            card_mod:
              style: |
                ha-card {
                  --ha-card-background: var(--card-background-color);
                  color: var(--primary-color); 
                }
          - type: custom:flex-horseshoe-card
            entities:
              - entity: sensor.pv_power
                decimals: 0
                unit: W
                name: Solar
              - entity: sensor.sun12k_pv1_power
                decimals: 0
                unit: W
                name: PV1
              - entity: sensor.sun12k_pv2_power
                decimals: 0
                unit: W
                name: PV2
              - entity: sensor.sun12k_pv1_voltage
                decimals: 0
                unit: V
              - entity: sensor.sun12k_pv2_voltage
                decimals: 0
                unit: V
              - entity: sensor.sun12k_pv1_current
                decimals: 1
                unit: A
              - entity: sensor.sun12k_pv2_current
                decimals: 1
                unit: A
              - entity: sensor.sun12k_daily_production
                decimals: 2
                unit: kWh
                name: Daily
            show:
              horseshoe_style: autominmax
            layout:
              hlines:
                - id: 0
                  xpos: 50
                  ypos: 40
                  length: 70
                  styles:
                    - opacity: 0.2;
              vlines:
                - id: 0
                  xpos: 50
                  ypos: 59
                  length: 36
                  styles:
                    - opacity: 0.2;
              states:
                - id: 0
                  entity_index: 0
                  xpos: 50
                  ypos: 33
                  styles:
                    - font-size: 3em;
                    - opacity: 0.9;
                - id: 1
                  entity_index: 1
                  xpos: 47
                  ypos: 53
                  styles:
                    - font-size: 1.5em;
                    - text-anchor: end;
                - id: 2
                  entity_index: 2
                  xpos: 53
                  ypos: 53
                  styles:
                    - text-anchor: start;
                    - font-size: 1.5em;
                - id: 3
                  entity_index: 3
                  xpos: 46
                  ypos: 63
                  styles:
                    - text-anchor: end;
                    - font-size: 1.5em;
                - id: 4
                  entity_index: 4
                  xpos: 53
                  ypos: 63
                  styles:
                    - text-anchor: start;
                    - font-size: 1.5em;
                - id: 5
                  entity_index: 5
                  xpos: 46
                  ypos: 73
                  styles:
                    - text-anchor: end;
                    - font-size: 1.5em;
                - id: 6
                  entity_index: 6
                  xpos: 53
                  ypos: 73
                  styles:
                    - text-anchor: start;
                    - font-size: 1.5em;
                - id: 7
                  entity_index: 7
                  xpos: 0
                  ypos: 7
                  styles:
                    - text-anchor: start;
                    - font-size: 1.2em;
              icons:
                - id: 0
                  entity_index: 1
                  xpos: 1
                  ypos: 53
                  align: start
                  size: 1
                - id: 1
                  entity_index: 2
                  xpos: 53
                  ypos: 65
                  align: end
                  size: 0.5
              names:
                - id: 0
                  entity_index: 0
                  xpos: 50
                  ypos: 95
                  styles:
                    - font-size: 1.2em;
                - id: 1
                  entity_index: 1
                  xpos: 15
                  ypos: 45
                  styles:
                    - text-anchor: start;
                    - font-size: 0.5em;
                - id: 2
                  entity_index: 2
                  xpos: 85
                  ypos: 45
                  styles:
                    - text-anchor: end;
                    - font-size: 0.5em;
                - id: 3
                  entity_index: 7
                  xpos: 0
                  ypos: 12
                  styles:
                    - text-anchor: start;
                    - font-size: 0.5em;
            horseshoe_scale:
              min: 0
              max: 10000
              width: 6
            color_stops:
              '0': orange
              '9000': yellow
        column_span: 3
      - type: grid
        cards:
          - type: custom:sunsynk-power-flow-card
            cardstyle: compact
            card_height: 100%
            show_solar: true
            battery:
              energy: 71344
              show_daily: true
              max_power: 10000
              shutdown_soc: sensor.pv_battery_soc_limit
              show_absolute: false
              show_remaining_energy: false
              remaining_energy_to_shutdown: false
              dynamic_colour: true
              auto_scale: true
              colour:
                - 0
                - 238
                - 255
              charge_colour:
                - 0
                - 255
                - 0
            solar:
              show_daily: true
              mppts: 2
              pv1_name: PV1
              pv2_name: PV2
              pv1_max_power: 10320
              pv2_max_power: 3440
              dynamic_colour: true
              efficiency: 3
              auto_scale: true
              max_power: 12000
            load:
              show_daily: true
              dynamic_colour: true
              dynamic_icon: true
              auto_scale: true
              load1_name: Werkstatt
              load1_icon: mdi:hammer-wrench
              additional_loads: 2
              load2_name: Garage
              load2_icon: mdi:garage
            grid:
              show_daily_buy: true
              show_daily_sell: true
              show_nonessential: false
              auto_scale: true
              label_daily_grid_buy: Import
              grid_name: Netz
              label_daily_grid_sell: Export
              show_absolute: false
              colour:
                - 140
                - 140
                - 140
              export_colour:
                - 251
                - 0
                - 255
              off_threshold: 100
            entities:
              inverter_status_59: sensor.sunsynk_overall_state
              day_battery_discharge_71: sensor.sun12k_daily_battery_discharge
              battery_voltage_183: sensor.sun12k_battery_voltage
              battery_current_191: sensor.sun12k_battery_output_current
              day_grid_import_76: sensor.sun12k_daily_energy_bought
              day_grid_export_77: sensor.sun12k_daily_energy_sold
              essential_power: none
              nonessential_power: none
              pv1_power_186: sensor.sun12k_pv1_power
              pv2_power_187: sensor.sun12k_pv2_power
              pv1_voltage_109: sensor.sun12k_pv1_voltage
              pv1_current_110: sensor.sun12k_pv1_current
              pv2_voltage_111: sensor.sun12k_pv2_voltage
              pv2_current_112: sensor.sun12k_pv2_current
              day_pv_energy_108: sensor.sun12k_daily_production
              total_pv_generation: sensor.sun12k_total_pv_production
              pv_total: sensor.pv_power
              battery_soc_184: sensor.sun12k_battery_capacity
              battery_power_190: sensor.sun12k_battery_output_power
              battery_temp_182: sensor.sun12k_battery_temperature
              battery_rated_capacity: '70'
              grid_power_169: sensor.sun12k_out_of_grid_total_power
              radiator_temp_91: sensor.sun12k_heat_sink_temperature
              grid_ct_power_172: sensor.sun12k_external_ct_l1_power
              grid_ct_power_L2: sensor.sun12k_external_ct_l2_power
              grid_ct_power_L3: sensor.sun12k_external_ct_l3_power
              grid_ct_power_total: sensor.sun12k_total_grid_power
              solar_sell_247: switch.sun12k_solar_sell
              day_battery_charge_70: sensor.sun12k_daily_battery_charge
              use_timer_248: switch.sun12k_time_of_use
              inverter_power_175: sensor.sun12k_inverter_power
              load_frequency_192: sensor.sun12k_load_frequency
              prog1_time: number.sun12k_time_point_1_start
              prog1_capacity: number.sun12k_time_point_1_capacity
              prog1_charge: switch.sun12k_time_point_1_charge_enable
              prog2_time: number.sun12k_time_point_2_start
              prog2_capacity: number.sun12k_time_point_2_capacity
              prog2_charge: switch.sun12k_time_point_2_charge_enable
              prog3_time: number.sun12k_time_point_3_start
              prog3_capacity: number.sun12k_time_point_3_capacity
              prog3_charge: switch.sun12k_time_point_3_charge_enable
              prog4_time: number.sun12k_time_point_4_start
              prog4_capacity: number.sun12k_time_point_4_capacity
              prog4_charge: switch.sun12k_time_point_4_charge_enable
              prog5_time: number.sun12k_time_point_5_start
              prog5_capacity: number.sun12k_time_point_5_capacity
              prog5_charge: switch.sun12k_time_point_5_charge_enable
              prog6_time: number.sun12k_time_point_6_start
              prog6_capacity: number.sun12k_time_point_6_capacity
              prog6_charge: switch.sun12k_time_point_6_charge_enable
              day_load_energy_84: sensor.sun12k_daily_load_energy
              load_power_L1: sensor.sun12k_load_l1_power
              load_power_L2: sensor.sun12k_load_l2_power
              load_power_L3: sensor.sun12k_load_l3_power
              environment_temp: sensor.temperatur_aussen
              essential_load1: sensor.werkstatt_leistung
              essential_load2: sensor.garage_leistung
            show_battery: true
            show_grid: true
            inverter:
              three_phase: true
              modern: true
              autarky: energy
              auto_scale: true
              model: deye
              colour:
                - 255
                - 255
                - 255
            grid_options:
              columns: full
              rows: 8
            large_font: false
            wide: false
            decimal_places_energy: 1
            dynamic_line_width: false
            view_layout:
              grid-area: o1
        column_span: 2
      - type: grid
        cards:
          - type: custom:apexcharts-card
            apex_config:
              chart:
                height: 350px
            all_series_config:
              unit: ' kWh'
            header:
              title: Solar forecast
              show: true
              standard_format: true
              show_states: true
              colorize_states: true
            graph_span: 2d
            span:
              start: day
              offset: +0h
            now:
              show: true
              color: red
            yaxis:
              - id: kwh
                min: 0
                apex_config:
                  tickAmount: 4
              - id: header_only
                show: false
            series:
              - entity: sensor.pv_power
                name: Actual Power
                type: area
                float_precision: 1
                color: '#ff9800'
                opacity: 0.5
                stroke_width: 2
                yaxis_id: kwh
                unit: W
                extend_to: now
                show:
                  legend_value: true
                  in_header: false
                group_by:
                  func: median
                  duration: 5m
              - entity: sensor.energy_production_today_all
                yaxis_id: kwh
                type: area
                name: Forecast Power
                color: grey
                opacity: 0.3
                data_generator: |
                  return Object.entries(entity.attributes.wh_period).map(
                    ([key, value]) => [new Date(key).getTime(), value]
                  );    
                show:
                  legend_value: false
                  in_header: false
                stroke_width: 2
                float_precision: 2
                extend_to: false
                group_by:
                  func: median
                  duration: 1m
              - entity: sensor.energy_production_tomorrow_all
                yaxis_id: kwh
                type: area
                name: Tomorrow
                color: light_grey
                data_generator: |
                  return Object.entries(entity.attributes.wh_period).map(
                    ([key, value]) => [new Date(key).getTime(), value]
                  );
                show:
                  legend_value: false
                  in_header: false
                stroke_width: 3
                float_precision: 2
                extend_to: false
              - entity: sensor.sun12k_daily_production
                yaxis_id: header_only
                name: PV Today
                color: orange
                show:
                  legend_value: true
                  in_header: true
                  in_chart: false
              - entity: sensor.energy_production_today_all
                yaxis_id: header_only
                name: Forcast Today
                color: orange
                show:
                  legend_value: true
                  in_header: true
                  in_chart: false
              - entity: sensor.energy_production_today_remaining_all
                yaxis_id: header_only
                name: Remaining Today
                color: orange
                show:
                  legend_value: true
                  in_header: true
                  in_chart: false
              - entity: sensor.energy_production_tomorrow_all
                yaxis_id: header_only
                name: Forecast Tomorrow
                color: grey
                show:
                  legend_value: true
                  in_header: true
                  in_chart: false
    max_columns: 3
    dense_section_placement: true
  - title: Misc
    sections:
      - type: grid
        cards:
          - type: heading
            heading: Inverter Batterie
            heading_style: title
            icon: mdi:battery
          - type: gauge
            entity: sensor.pv_batterie_zellenspannung
            max: 3.65
            needle: true
            severity:
              green: 3.3
              yellow: 3.1
              red: 2.8
            min: 2.5
          - type: entities
            entities:
              - entity: sensor.sun12k_total_charge_of_the_battery
                name: Total charge
              - entity: sensor.sun12k_total_discharge_of_the_battery
                name: Total discharge
              - entity: sensor.pv_battery_efficiency
              - entity: sensor.pv_battery_max_24h
              - entity: sensor.pv_battery_soc_limit
          - type: entities
            entities:
              - entity: sensor.sun12k_bms_voltage
              - entity: sensor.sun12k_bms_current
              - entity: sensor.sun12k_bms_charging_voltage
              - entity: sensor.sun12k_bms_charging_current_limit
              - entity: sensor.sun12k_bms_discharge_current_limit
            title: Inverter BMS data
          - show_name: true
            show_icon: true
            type: button
            tap_action:
              action: toggle
            entity: switch.yambms_relay
            name: Inverter Fans Off
            show_state: true
            icon: mdi:fan
          - show_name: true
            show_icon: true
            type: button
            entity: switch.lichterkette2
            show_state: false
      - type: grid
        cards:
          - type: heading
            heading_style: title
            icon: mdi:calculator
            heading: Verschiedenes
          - type: entities
            entities:
              - entity: sensor.last_median_24h
              - entity: sensor.last_max_24h
              - entity: sensor.last_min_24h
              - entity: sensor.netz_median
              - entity: sensor.netz_max_24h
              - entity: sensor.pv_max_7d
              - entity: sensor.last_median_7d
              - entity: sensor.lastabweichung
              - entity: sensor.required_charging_current
      - type: grid
        cards:
          - type: custom:auto-entities
            card:
              type: entities
            filter:
              include:
                - options: {}
                  entity_id: sensor.yambms2*
                  sort:
                    numeric: false
                    method: friendly_name
                - options: {}
                  entity_id: binary_sensor.yambms2*
              exclude: []
    badges: []
    type: sections
    max_columns: 3
    cards: []
  - type: sections
    title: Settings
    path: settings
    icon: mdi:cog-outline
    sections:
      - type: grid
        cards:
          - type: heading
            heading_style: title
            heading: Settings
          - type: entities
            entities:
              - entity: number.sun12k_max_solar_power
              - entity: select.sun12k_energy_priority
              - entity: number.sun12k_maximum_battery_charge_current
              - entity: switch.sun12k_grid_charge
              - entity: number.sun12k_grid_charging_start_capacity
              - entity: number.sun12k_time_point_1_start
              - entity: switch.sun12k_time_point_1_charge_enable
              - entity: number.sun12k_time_point_1_capacity
              - entity: number.sun12k_time_point_2_start
              - entity: switch.sun12k_time_point_2_charge_enable
              - entity: number.sun12k_time_point_2_capacity
              - entity: number.sun12k_time_point_3_start
              - entity: switch.sun12k_time_point_3_charge_enable
              - entity: number.sun12k_time_point_3_capacity
              - entity: number.sun12k_time_point_4_start
              - entity: switch.sun12k_time_point_4_charge_enable
              - entity: number.sun12k_time_point_4_capacity
              - entity: number.sun12k_time_point_5_start
              - entity: switch.sun12k_time_point_5_charge_enable
              - entity: number.sun12k_time_point_5_capacity
              - entity: number.sun12k_time_point_6_start
              - entity: switch.sun12k_time_point_6_charge_enable
              - entity: number.sun12k_time_point_6_capacity
        column_span: 1
    cards: []
    max_columns: 1
  - type: sections
    max_columns: 2
    path: ''
    sections:
      - type: grid
        cards:
          - type: custom:plotly-graph
            raw_plotly_config: true
            hours_to_show: 1y
            refresh_interval: 5m
            title: Max Solar Power [W]
            layout:
              autosize: true
              margin:
                t: 0
                l: 55
                r: 45
                b: 65
              xaxis:
                title: Azimuth [°]
              yaxis:
                title: Elevation [°]
            entities:
              - entity: sensor.sun_solar_azimuth
                internal: true
                period: 5minute
                fn: |-
                  $fn ({ xs, ys, vars }) => {
                    vars.azimuth_raw_x_ = xs.map(x => x.getTime());
                    vars.azimuth_raw_y_ = ys;
                  }
              - entity: sensor.sun_solar_azimuth
                internal: true
                statistic: mean
                period: hour
                fn: |-
                  $fn ({ xs, ys, vars }) => {
                    const xs_ = xs.map(x => x.getTime());
                    const i = xs_.findIndex(x => x > vars.azimuth_raw_x_[0]);
                    vars.azimuth_raw_x = xs_.slice(0, i);
                    vars.azimuth_raw_y = ys.slice(0, i);
                  }
              - entity: sensor.sun_solar_elevation
                internal: true
                period: 5minute
                fn: |-
                  $fn ({ xs, ys, vars }) => {
                    vars.elevation_raw_x_ = xs.map(x => x.getTime());
                    vars.elevation_raw_y_ = ys;
                  }
              - entity: sensor.sun_solar_elevation
                internal: true
                statistic: mean
                period: hour
                fn: |-
                  $fn ({ xs, ys, vars }) => {
                    const xs_ = xs.map(x => x.getTime());
                    const i = xs_.findIndex(x => x > vars.elevation_raw_x_[0]);
                    vars.elevation_raw_x = xs_.slice(0, i);
                    vars.elevation_raw_y = ys.slice(0, i);
                  }
              - entity: sensor.pv_power
                internal: true
                period: 5minute
                fn: |-
                  $fn ({ xs, ys, vars }) => {
                    vars.power_raw_x_ = xs.map(x => x.getTime());
                    vars.power_raw_y_ = ys;
                  }
              - entity: sensor.pv_power
                internal: true
                statistic: mean
                period: hour
                fn: |-
                  $fn ({ xs, ys, vars }) => {
                    const xs_ = xs.map(x => x.getTime());
                    const i = xs_.findIndex(x => x > vars.power_raw_x_[0]);
                    vars.power_raw_x = xs_.slice(0, i);
                    vars.power_raw_y = ys.slice(0, i);
                  }
              - entity: ''
                type: heatmap
                hoverongaps: false
                colorscale: Rainbow
                fn: |-
                  $fn ({ xs, ys, vars }) => {
                    const x = Array.from({ length: 220 + 1 }, (e, i) => 70 + i);
                    const y = Array.from({ length:  70 + 1 }, (e, i) =>  0 + i);
                    const z = Array(y.length).fill(null).map(() => Array(x.length).fill(NaN));

                    for (let i = 0; i < vars.power_raw_y.length; i++) {
                      const pw = vars.power_raw_y[i];
                      const ix = vars.power_raw_x[i];

                      const azi = vars.azimuth_raw_x.indexOf(ix);
                      const eli = vars.elevation_raw_x.indexOf(ix);

                      if (azi >= 0 && eli >= 0) {
                        const az = vars.azimuth_raw_y[azi];
                        const el = vars.elevation_raw_y[eli];

                        const pos_az_min = x.indexOf(Math.floor(az));
                        const pos_el_min = y.indexOf(Math.floor(el));
                        const pos_az_max = x.indexOf(Math.ceil(az));
                        const pos_el_max = y.indexOf(Math.ceil(el));

                        if (pos_az_min >= 0 && pos_el_min >= 0 && pos_az_max >= 0 && pos_el_max >= 0) {
                          for (let pos_az = pos_az_min; pos_az <= pos_az_max; pos_az++) {
                            for (let pos_el = pos_el_min; pos_el <= pos_el_max; pos_el++) {
                              if (isNaN(z[pos_el][pos_az])) {
                                z[pos_el][pos_az] = pw;
                              } else {
                                z[pos_el][pos_az] = Math.max(z[pos_el][pos_az], pw);
                              }
                            }
                          }
                        }
                      }
                    }
                    for (let i = 0; i < vars.power_raw_y_.length; i++) {
                      const pw = vars.power_raw_y_[i];
                      const ix = vars.power_raw_x_[i];

                      const azi = vars.azimuth_raw_x_.indexOf(ix);
                      const eli = vars.elevation_raw_x_.indexOf(ix);

                      if (azi >= 0 && eli >= 0) {
                        const az = vars.azimuth_raw_y_[azi];
                        const el = vars.elevation_raw_y_[eli];

                        const pos_az_min = x.indexOf(Math.floor(az));
                        const pos_el_min = y.indexOf(Math.floor(el));
                        const pos_az_max = x.indexOf(Math.ceil(az));
                        const pos_el_max = y.indexOf(Math.ceil(el));

                        if (pos_az_min >= 0 && pos_el_min >= 0 && pos_az_max >= 0 && pos_el_max >= 0) {
                          for (let pos_az = pos_az_min; pos_az <= pos_az_max; pos_az++) {
                            for (let pos_el = pos_el_min; pos_el <= pos_el_max; pos_el++) {
                              if (isNaN(z[pos_el][pos_az])) {
                                z[pos_el][pos_az] = pw;
                              } else {
                                z[pos_el][pos_az] = Math.max(z[pos_el][pos_az], pw);
                              }
                            }
                          }
                        }
                      }
                    }
                    vars.x = x;
                    vars.y = y;
                    vars.z = z;
                  };
                x: $fn ({ vars }) => vars.x
                'y': $fn ({ vars }) => vars.y
                z: $fn ({ vars }) => vars.z
      - type: grid
        cards:
          - type: custom:plotly-graph
            hours_to_show: current_month
            entities:
              - entity: sensor.sun12k_total_consumption
                statistic: sum
                name: Total
                internal: true
                filters:
                  - delta
                  - resample: 1h
                  - map_y_numbers: y.toFixed(1)
                  - fn: |-
                      ({ xs, ys, vars, meta, states, statistics, hass }) => {
                        console.log("first", xs[0]);
                        console.log("last", xs[xs.length-1]);
                        vars.hourData = [...Array(25).keys()];
                        for (let i = 0; i < xs.length; i++) {
                          if (Array.isArray(vars.hourData[xs[i].getHours()])) {
                          vars.hourData[xs[i].getHours()].push(ys[i])
                          } else {
                            vars.hourData[xs[i].getHours()] = [ys[i]]
                          }
                        }
                      }
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[1]
                name: '0:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[2]
                name: '1:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[3]
                name: '2:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[4]
                name: '3:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[5]
                name: '4:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[6]
                name: '5:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[7]
                name: '6:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[8]
                name: '7:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[9]
                name: '8:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[10]
                name: '9:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[11]
                name: '10:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[12]
                name: '11:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[13]
                name: '12:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[14]
                name: '13:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[15]
                name: '14:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[16]
                name: '15:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[17]
                name: '16:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[18]
                name: '17:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[19]
                name: '18:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[20]
                name: '19:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[21]
                name: '20:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[22]
                name: '21:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[23]
                name: '22:00'
              - entity: ''
                type: box
                'y': $fn ({vars}) => vars.hourData[0]
                name: '23:00'
            defaults:
              entity:
                boxpoints: all
                jitter: 0.2
                marker:
                  size: 3
            raw_plotly_config: true
            layout:
              clickmode: none
              hovermode: x
              title:
                text: Hourly Energy Statistics
                x: 0.05
                'y': 1.1
              yaxis:
                rangemode: tozero
                title: kWh
              showlegend: false
    icon: mdi:chart-bar
    visible:
      - user: 73563cef4cf54656b5be58d78fd28c7c
    cards: []
